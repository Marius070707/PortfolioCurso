En esta actividad aprendimos a usar contenedores para trabajar con SonarQube sin tener que 
instalar todo directamente en el ordenador. Vimos que SonarQube sirve para analizar el código
y encontrar errores, fallos de seguridad o cosas que se pueden mejorar. Para hacerlo usamos
Docker, creando varios contenedores, uno para SonarQube y otro para la base de datos.

El proyecto se guarda en el propio ordenador y los contenedores acceden a él para poder analizarlo.
También vimos cómo iniciar todo con docker compose y entrar a SonarQube desde el navegador. La idea
es tener un entorno de desarrollo ordenado y fácil de repetir sin romper nada del sistema. En resumen
aprendimos una forma más cómoda y profesional de revisar la calidad del código usando contenedores.

preparamos carpeta del proyecto

mkdir -p ~/proyectos/sonarqube-docker
cd ~/proyectos/sonarqube-docker

Ver el valor actual
sysctl vm.max_map_count
Si te devuelve algo como 65530 o mas bajo, hay que subirlo.

Subirlo temporalmente (hasta reinicio)
sudo sysctl -w vm.max_map_count=262144
Hacerlo permanente
echo "vm.max_map_count=262144" | sudo tee /etc/sysctl.d/99-sonarqube.conf
sudo sysctl --system

Comprobación final:

sysctl vm.max_map_count

En la carpeta ~/proyectos/sonarqube-docker crea el archivo:

nano docker-compose.yml
Pega esto:

services:
  db:
    image: postgres:15
    container_name: sonar-db
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonarqube
    volumes:
      - sonar_db_data:/var/lib/postgresql/data
    networks:
      - sonar-net
    restart: unless-stopped

  sonarqube:
    image: sonarqube:community
    container_name: sonarqube
    depends_on:
      - db
    ports:
      - "9000:9000"
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonarqube
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions
      - sonar_logs:/opt/sonarqube/logs
    networks:
      - sonar-net
    restart: unless-stopped

volumes:
  sonar_db_data:
  sonar_data:
  sonar_extensions:
  sonar_logs:

networks:
  sonar-net:
    driver: bridge

 Arrancar SonarQube
En la misma carpeta:

docker compose up -d

Ver logs y esperar a que esté listo
SonarQube tarda un poco en arrancar (no es instantáneo).

Para ver el estado:

docker logs -f sonarqube

 Acceso web y primer login
Abre en el navegador:

http://localhost:9000

Mira logs:

docker logs --tail 200 sonarqube

Estructura de carpetas (base del universo)
Cada grupo trabajará con esta estructura:

mkdir -p ~/proyectos/grupo01/proyecto-php/src
mkdir -p ~/proyectos/grupo01/proyecto-java/src
cd ~/proyectos/grupo01

Proyecto PHP con Apache en contenedor
Entramos:

cd ~/proyectos/grupo01/proyecto-php
Crear archivo PHP con “malos olores”
nano src/index.php

Pega esto:

<?php

function suma($a, $b){
    return $a + $b;
}

function suma2($a, $b){ // duplicación
    return $a + $b;
}

$x = 5;
$y = 10;

if($x == $y){
    echo "Son iguales";
} else {
    echo "No son iguales";
}

echo "<br>Resultado: " . suma($x, $y);

// Código muerto
$z = 100;

?>

Crear docker-compose del proyecto PHP
nano docker-compose.yml
services:
  php-apache:
    image: php:8.2-apache
    container_name: php-grupo01
    ports:
      - "8081:80"
    volumes:
      - ./src:/var/www/html
    restart: unless-stopped
Arrancar:

docker compose up -d

Crear configuración básica de Sonar para PHP
En la raíz del proyecto PHP:

nano sonar-project.properties
sonar.projectKey=lab1-php
sonar.projectName=Proyecto PHP Lab1
sonar.projectVersion=1.0
sonar.sources=src
sonar.sourceEncoding=UTF-8

Crear Token en SonarQube
El scanner necesita autenticarse. No se usan usuario/contraseña, se usa token.

Paso 1 — Entrar en SonarQube
Abrir:

http://localhost:9000 o http://ipservidor:9000

aso 2 — Crear token
Ir a:

User → My Account → Security → Generate Token

Nombre sugerido:

scanner-grupo01

Ejecutar Sonar Scanner desde contenedor
No instalamos nada en el host. Usamos un contenedor efímero. Limpio. Reproducible. Profesional.

Nos situamos en el proyecto PHP:

cd ~/proyectos/grupo01/proyecto-php
Ahora ejecutamos:

sudo docker run --rm --network host \
  -e SONAR_HOST_URL="http://127.0.0.1:9000" \
  -e SONAR_TOKEN="sqa_3a808da1a78a8cbefd19cc39638a829ccb69e4ed" \
  -v "$(pwd):/usr/src" \
  -w /usr/src \
  sonarsource/sonar-scanner-cli \
  -Dsonar.ws.timeout=120 \
  -Dsonar.scanner.ws.timeout=120

  Ver el resultado del análisis
Ir a:

http://ip_del_server:9000

Entrar en:

Projects

Debería aparecer:

Proyecto PHP Grupo01

Analizar también el proyecto Java
Entramos:

cd ~/proyectos/grupo01/proyecto-java
Lanzamos scanner igual:

sudo docker run --rm --network host \
  -e SONAR_HOST_URL="http://127.0.0.1:9000" \
  -e SONAR_TOKEN="sqa_3a808da1a78a8cbefd19cc39638a829ccb69e4ed" \
  -v "$(pwd):/usr/src" \
  -w /usr/src \
  sonarsource/sonar-scanner-cli \
  -Dsonar.ws.timeout=120 \
  -Dsonar.scanner.ws.timeout=120
